<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome Home</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
        .container { max-width: 600px; margin: 80px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 40px; text-align: center; }
        h1 { color: #2c3e50; }
        h2 { color: #34495e; margin-top: 40px; }
        p { color: #555; }
        a { color: #3498db; text-decoration: none; }
        a:hover { text-decoration: underline; }
        #portfolio-row { margin-top: 40px; }
        #ticker-row { margin-top: 40px; }
        #holdings-table-container { margin-top: 16px; }
        #ticker-table-container { margin-top: 16px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px 12px; text-align: left; border: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
        button { background:#e74c3c;color:#fff;border:none;padding:8px 16px;border-radius:4px;cursor:pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div style="margin-bottom: 32px; position: relative;">
            <form action="/logout" method="post" style="position: absolute; top: 0; right: 0; margin: 0;">
                <button type="submit">Logout</button>
            </form>
            <h1>Welcome to Broker Online</h1>
        </div>
        <div id="portfolio-row">
            <h2>Your Portfolio Holdings</h2>
            <div id="holdings-table-container">
                <p>Loading holdings...</p>
            </div>
        </div>
        <div id="action-row" style="margin-top:40px;">
            <h2>API Actions</h2>
            <form id="api-action-form" style="margin-bottom:16px;">
                <select id="exchange-select" style="padding:8px;border-radius:4px;border:1px solid #ccc;"></select>
                <input type="text" id="api-input" list="name-list" placeholder="Instrument name" style="padding:8px;width:60%;border-radius:4px;border:1px solid #ccc;">
                <datalist id="name-list"></datalist>
                <button type="submit">Subscribe Ticker</button>
            </form>
            <button id="disconnect-btn" style="background:#888;">Disconnect Ticker</button>
            <div id="api-action-result" style="margin-top:16px;"></div>
        </div>
        <div id="ticker-row">
            <h2>Live Ticker Feed</h2>
            <div id="ticker-table-container">
                <p>No subscriptions yet.</p>
            </div>
        </div>
    </div>
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Portfolio fetch (existing)
        fetch('/api/portfolio/holdings')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const holdings = data.data;
                    let html = '<table style="width:100%;margin-top:16px;"><tr><th>Symbol</th><th>Exchange</th><th>Quantity</th><th>Avg Price</th><th>Last Price</th><th>P&amp;L</th></tr>';
                    holdings.forEach(h => {
                        html += `<tr><td>${h.tradingsymbol}</td><td>${h.exchange}</td><td>${h.quantity}</td><td>${h.average_price}</td><td>${h.last_price}</td><td>${h.pnl}</td></tr>`;
                    });
                    html += '</table>';
                    document.getElementById('holdings-table-container').innerHTML = html;
                } else {
                    document.getElementById('holdings-table-container').innerHTML = '<p>Failed to load holdings.</p>';
                }
            })
            .catch(() => {
                document.getElementById('holdings-table-container').innerHTML = '<p>Error loading holdings.</p>';
            });

        const nameTokenMap = {};
        function loadInstrumentData() {
            fetch('/api/instruments/exchanges')
                .then(r => r.json())
                .then(list => {
                    const sel = document.getElementById('exchange-select');
                    sel.innerHTML = list.map(e => `<option value="${e}">${e}</option>`).join('');
                });
            fetch('/api/instruments/names')
                .then(r => r.json())
                .then(list => {
                    const dl = document.getElementById('name-list');
                    dl.innerHTML = '';
                    list.forEach(item => {
                        nameTokenMap[item.name] = item.instrumentToken;
                        const opt = document.createElement('option');
                        opt.value = item.name;
                        dl.appendChild(opt);
                    });
                });
        }
        loadInstrumentData();

        // API action form for ticker subscribe
        document.getElementById('api-action-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('api-input').value;
            const token = nameTokenMap[name];
            if (!token) { return; }
            fetch('/api/ticker/subscribe', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'tokens=' + encodeURIComponent(token)
            })
            .then(res => res.text())
            .then(msg => {
                document.getElementById('api-action-result').innerText = msg;
            });
        });
        document.getElementById('disconnect-btn').addEventListener('click', function() {
            fetch('/api/ticker/disconnect', { method: 'POST' })
                .then(res => res.text())
                .then(msg => {
                    document.getElementById('api-action-result').innerText = msg;
                });
        });

        // WebSocket for live ticker feed
        let ws;
        function connectWebSocket() {
            // Example: ws://localhost:8080/ws/ticker (backend must support this!)
            ws = new WebSocket('ws://localhost:8080/ws/ticker');
            ws.onopen = () => {
                document.getElementById('ticker-table-container').innerHTML = '<p>Connected. Waiting for data...</p>';
            };
            ws.onmessage = (event) => {
                let data = JSON.parse(event.data);
                let html = '<table style="width:100%;margin-top:16px;"><tr><th>Token</th><th>Price</th><th>Timestamp</th></tr>';
                data.forEach(tick => {
                    html += `<tr><td>${tick.token}</td><td>${tick.price}</td><td>${tick.timestamp}</td></tr>`;
                });
                html += '</table>';
                document.getElementById('ticker-table-container').innerHTML = html;
            };
            ws.onclose = () => {
                document.getElementById('ticker-table-container').innerHTML = '<p>WebSocket disconnected.</p>';
            };
        }
        // Uncomment to auto-connect WebSocket on page load:
        // connectWebSocket();
        /*]]>*/
    </script>
</body>
</html>
